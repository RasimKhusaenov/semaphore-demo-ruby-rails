version: v1.0
name: Ruby on Rails CI

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

auto_cancel:
  queued:
    when: true
fail_fast:
  stop:
    when: true

global_job_config:
  prologue:
    commands:
      - checkout
      - cache restore
      - sem-service start postgres
      
      - sem-version ruby 2.7.3
      - bundle install
      - bundle exec rails db:setup
      - cache store
  env_vars:
    - name: DATABASE_URL
      value: postgresql://postgres@localhost/test
    - name: RAILS_ENV
      value: test

blocks:
  - name: Test
    task:
      jobs:
        - name: Run tests
          commands:
            - bundle exec rspec

  - name: Lint
    task:
      jobs:
        - name: Security audit dependencies
          commands:
            - bundle exec bundler-audit --update
        - name: Security audit application code
          commands:
            - bundle exec brakeman
        - name: Lint Ruby files
          commands:
            - bundle exec rubocop
