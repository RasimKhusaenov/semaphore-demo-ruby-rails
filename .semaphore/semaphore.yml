version: v1.0
name: Ruby on Rails CI
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
auto_cancel:
  running:
    when: true
fail_fast:
  stop:
    when: true

global_job_config:
  prologue:
    commands:
      - checkout
      - sem-service start postgres
      - sem-version ruby 2.7.3
      - bundle install

blocks:
  - name: Test
    task:
      jobs:
        - name: Run tests
          commands:
            - bundle exec rails db:setup
            - bundle exec rspec

  - name: Lint
    task:
      jobs:
        - name: Run quality
          commands:
            # Security audit dependencies
            - bundle exec bundler-audit --update
            # Security audit application code
            - bundle exec brakeman
            # Lint Ruby files
            - bundle exec rubocop
